# STM8 编译工具链查找机制

## 快速概览

本工程通过 **CMake工具链文件** 机制查找和使用SDCC编译器。整个过程在CMake配置阶段自动完成。

## 查找流程（简化版）

```
用户配置CMake
    ↓
设置 CMAKE_TOOLCHAIN_FILE = cmake/sdcc-generic.cmake
    ↓
CMake加载工具链文件
    ↓
工具链文件执行: find_program(sdcc REQUIRED)
    ↓
在系统PATH中查找 sdcc.exe (Windows) 或 sdcc (Linux/Mac)
    ↓
找到后设置: CMAKE_C_COMPILER = <sdcc完整路径>
    ↓
配置编译规则和输出格式
    ↓
项目使用SDCC编译器编译
```

## 详细机制

### 1. 工具链文件入口

**文件**: `cmake/sdcc-generic.cmake`

**关键代码**:
```cmake
# 第5行：查找SDCC编译器
find_program(SDCC_COMPILER sdcc REQUIRED)

# 第6行：设置为C编译器
set(CMAKE_C_COMPILER "${SDCC_COMPILER}" CACHE FILEPATH "SDCC Compiler" FORCE)
```

**查找位置**:
- 系统 `PATH` 环境变量中的所有目录
- CMake的默认搜索路径

### 2. 如何指定工具链文件

#### 方式1: CMake预设（当前使用）

```json
// CMakePresets.json
{
    "cacheVariables": {
        "CMAKE_TOOLCHAIN_FILE": {
            "value": "${sourceDir}/cmake/sdcc-generic.cmake"
        }
    }
}
```

#### 方式2: 命令行参数

```bash
cmake -DCMAKE_TOOLCHAIN_FILE=cmake/sdcc-generic.cmake ...
```

#### 方式3: VSCode设置

```json
// .vscode/settings.json
{
    "cmake.configureSettings": {
        "CMAKE_TOOLCHAIN_FILE": "${workspaceFolder}/cmake/sdcc-generic.cmake"
    }
}
```

### 3. 工具链文件执行时机

**重要**: 工具链文件在CMake检测编译器**之前**执行！

```
CMake启动
    ↓
读取 CMakeLists.txt
    ↓
【工具链文件在这里执行】← 关键时机
    ↓
CMake检测编译器（如果工具链文件未设置）
    ↓
配置项目
```

### 4. SDCC编译器查找

**代码**: `find_program(SDCC_COMPILER sdcc REQUIRED)`

**查找过程**:
1. 在 `CMAKE_PROGRAM_PATH` 中查找
2. 在系统 `PATH` 中查找
3. 在CMake默认路径中查找

**查找的文件名**:
- Windows: `sdcc.exe`
- Linux/Mac: `sdcc`

**如果找到**:
- `SDCC_COMPILER` = 完整路径，例如 `C:/SDCC/bin/sdcc.exe`

**如果未找到**:
- CMake配置失败（`REQUIRED` 关键字）
- 错误信息: `Could not find sdcc`

### 5. 相关工具查找

工具链文件还会查找SDCC相关的工具：

```cmake
# 获取SDCC安装目录
get_filename_component(SDCC_LOCATION "${CMAKE_C_COMPILER}" DIRECTORY)

# 查找工具（优先在SDCC目录，然后在PATH）
find_program(CMAKE_OBJCOPY sdobjcopy PATHS "${SDCC_LOCATION}" NO_DEFAULT_PATH)
find_program(CMAKE_OBJCOPY sdobjcopy)  # 如果上面没找到，在PATH中查找

find_program(CMAKE_PACKIHX packihx ...)
find_program(SDCCLIB_EXECUTABLE sdcclib ...)
```

**查找策略**:
1. 先在SDCC安装目录查找（确保版本匹配）
2. 如果没找到，在系统PATH中查找

### 6. 编译器设置

```cmake
# 强制设置编译器
set(CMAKE_C_COMPILER "${SDCC_COMPILER}" CACHE FILEPATH "SDCC Compiler" FORCE)

# 跳过编译器测试（交叉编译器不需要）
set(CMAKE_C_COMPILER_WORKS TRUE CACHE INTERNAL "")

# 明确标识编译器类型
set(CMAKE_C_COMPILER_ID "SDCC" CACHE INTERNAL "")
```

**为什么需要 `FORCE`**:
- CMake可能已经自动检测到其他编译器（如GCC）
- `FORCE` 强制使用SDCC，覆盖自动检测结果

### 7. 编译规则配置

工具链文件配置了SDCC特有的编译和链接规则：

```cmake
# 编译命令: sdcc -mstm8 --std-c99 -D... -I... -o file.rel -c file.c
set(CMAKE_C_COMPILE_OBJECT 
    "<CMAKE_C_COMPILER> <DEFINES> <INCLUDES> <FLAGS> -o <OBJECT> -c <SOURCE>")

# 链接命令: sdcc ... --out-fmt-ihx -o file.ihx ...
set(CMAKE_C_LINK_EXECUTABLE 
    "<CMAKE_C_COMPILER> <FLAGS> <OBJECTS> --out-fmt-ihx -o <TARGET> ...")
```

**输出格式**:
- 可执行文件: `.ihx` (Intel Hex格式)
- 目标文件: `.rel` (SDCC目标文件)
- 静态库: `.lib`

## 实际查找示例

### 场景1: SDCC在PATH中

```
PATH = C:\Windows\System32;C:\SDCC\bin;...

CMake执行: find_program(sdcc)
    ↓
查找: C:\Windows\System32\sdcc.exe (不存在)
    ↓
查找: C:\SDCC\bin\sdcc.exe (找到！)
    ↓
设置: CMAKE_C_COMPILER = C:\SDCC\bin\sdcc.exe
```

### 场景2: SDCC不在PATH中

```
CMake执行: find_program(sdcc REQUIRED)
    ↓
在所有PATH目录中查找
    ↓
未找到 sdcc.exe
    ↓
CMake配置失败
错误: Could not find sdcc (missing: SDCC_COMPILER)
```

## 关键文件

| 文件 | 作用 |
|------|------|
| `cmake/sdcc-generic.cmake` | SDCC工具链主文件，查找编译器 |
| `cmake/sdcc-stm8.cmake` | STM8系列配置 |
| `cmake/sdcc-stm8l.cmake` | STM8L系列特定配置 |
| `CMakePresets.json` | CMake预设，指定工具链文件路径 |
| `.vscode/settings.json` | VSCode配置（备用） |

## 验证方法

### 1. 检查SDCC是否在PATH中

```powershell
where sdcc
# 如果输出路径，说明在PATH中
# 如果无输出，说明不在PATH中
```

### 2. 查看CMake配置输出

配置项目后，查看输出：
```
-- The C compiler identification is SDCC
-- Found SDCC: C:/SDCC/bin/sdcc.exe
```

### 3. 查看CMake缓存

```bash
cmake -L -N build/stm8l-gpio | findstr CMAKE_C_COMPILER
```

应该显示：
```
CMAKE_C_COMPILER:FILEPATH=C:/SDCC/bin/sdcc.exe
```

## 常见问题

### Q: 为什么找到了Qt的CMake？

**A**: CMake Tools可能在PATH中找到了Qt的CMake。解决方法：
- 在 `.vscode/settings.json` 中指定系统CMake路径
- 或调整PATH顺序

### Q: 工具链文件什么时候执行？

**A**: 在CMake检测编译器之前执行，这是工具链文件机制的核心。

### Q: 如果SDCC不在PATH中怎么办？

**A**: 
1. 将SDCC添加到系统PATH
2. 或在工具链文件中使用完整路径

### Q: 如何确认使用了正确的编译器？

**A**: 查看CMake输出中的 `CMAKE_C_COMPILER_ID`，应该是 `SDCC`。

## 总结

本工程的工具链查找机制：

1. ✅ **通过CMake工具链文件**指定SDCC
2. ✅ **在PATH中查找**sdcc可执行文件
3. ✅ **强制设置编译器**避免自动检测冲突
4. ✅ **配置编译规则**适配SDCC特性
5. ✅ **查找相关工具**确保工具链完整

**核心**: 工具链文件在CMake初始化阶段执行，确保使用SDCC而不是系统默认编译器。

